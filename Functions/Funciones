#!/bin/bash 

function SeleccionarHistorico() {
    fichero=$1

    if [ -e $fichero ]; then
        HISTFILE=$fichero

        export HISTFILE
    fi
}

function ElegirHistorico() {
    dir=`ls ~/.History/Histories | zenity --list --column "Seleccione Directorio"`
    if [ $dir != "" ]; then
        hist=`ls ${HOME}/.History/Histories/${dir} | zenity --list --column "Seleccione Histórico"`
    else
        zenity --info --text="Operación cancelada."
        . ${HOME}/.History/Scripts/exec
    fi
}

function GuardarSinRepetir() {
    rutaorigen=$1
    rutadestino=$2
    dir=$(dirname "$rutadestino")
    ficherooriginal=$3
    let count=0
    while [ -e $rutadestino ]
    do
        let count=${count}+1
        fichero=${ficherooriginal}"${count}"
        rutadestino="${dir}/${fichero}"
    done
    cp $rutaorigen $rutadestino
    if [ $? -eq 0 ]; then
        exito=true
    else
        exito=false
    fi
}

function NuevoHistorico(){

    touch ${HOME}/.History/.Temp/aux.temp
    SeleccionarHistorico ${HOME}/.History/.Temp/aux.temp
    bash

}

function GuardarHistorico(){

    zenity --question --text "Guardar?"
    if [ $? = 0 ];then
       
        mv ${HOME}/.History/.Temp/aux.temp ${HOME}/.History/Histories/Custom/`date +%y_%m_%d`
        SeleccionarHistorico ${HOME}/.History/Histories/Custom/`date +%y_%m_%d`
        zenity --info --text="Historico guardado."
    else 
        rm ${HOME}/.History/.Temp/aux.temp
        zenity --info --text="Historico descartado."
    fi
}

function ElegirHistoricos(){
#Creamos un array asociativo que contenga para cada directorio seleccionado, una lista con los ficheros selecionados a borrar
    dir=`ls ~/.History/Histories | awk '{print "FALSE\n"$0}' | zenity --list --checklist --column="Acceder?" --column="Directorios" --separator=" "`
    declare -A arrayHistoricos
    set $dir

    while [ "$1" != "" ]
    do
        hist=`ls ~/.History/Histories/${1} | awk '{print "FALSE\n"$0}' | zenity --list --checklist --column="Borrar?" --column="Históricos" --separator=" "`
        arrayHistoricos[$1]="$hist"
        let count=count+1
        shift
    done
    #Comprobamos que ha ido bien la seleccion de ficheros
    if [ $? = 0 ]; then
        zenity --info --text="Operación completada."
    else
        zenity --info --text="Operación cancelada."
        . ${HOME}/.History/Scripts/manage
    fi
    
    declare -a array
    for i in "${!arrayHistoricos[@]}";
    do  
        split=`echo "${arrayHistoricos[$i]}" | tr ' ' ':'`
        string=`echo "${i};$split"`
        array+=("$string") 
    done
    echo "${array[@]}"
}

#Funcion que permite elegir varios historicos de diferentes directorios y eliminarlos a la vez 
function EliminarHistoricos() {
    
    declare -a aux=$(ElegirHistoricos)
    declare -A arrayBuena

    for linea in ${aux[@]};
    do
        IFS=';' read -ra PAR <<< "$linea"
        clave="${PAR[0]}"
        valor="${PAR[1]}"
        arrayBuena["${clave}"]="${valor}"
    done
    echo $arrayBuena
    #Bucle para borrar la lista de ficheros que hemos definido de cada directorio
    for index in "${!arrayBuena[@]}"
    do
        directorio=$index
        split=`echo "${arrayBuena[$index]}" | tr ':' ' '`
        ficheros="$split" 
        set $ficheros
            while [ "$1" != "" ]
            do  
                if [ -e ${HOME}/.History/Histories/${directorio}/${1} ];then
                    rm ${HOME}/.History/Histories/${directorio}/${1}
                fi
                shift
            done    
    done
} 

function Importar() {
    rutaorigen=$1
    ficherooriginal=$(basename "$rutaorigen")
    fichero=$ficherooriginal
    rutadestino="${HOME}/.History/Histories/Custom/${fichero}"

    if [ -e $rutaorigen ]; then
        GuardarSinRepetir $rutaorigen $rutadestino $ficherooriginal
        if [ $exito == true ]; then
            resultado="Fichero importado al directorio ${dir} con el nombre: ${fichero}"
        else
            resultado='Algo salio mal y no se pudo realizar la importación'
        fi
    fi
}

function Exportar() {
    dir=$1
    hist=$2
    rutaorigen="${HOME}/.History/Histories/${dir}/${hist}"
    ficherooriginal=$(basename "$rutaorigen")
    fichero=$ficherooriginal
    dirdestino=`zenity --file-selection --directory --filename=${HOME}/ --title="Seleccione Directorio de destino"`
    rutadestino="${dirdestino}/${fichero}"

    if [ -e $rutaorigen ]; then
        GuardarSinRepetir $rutaorigen $rutadestino $ficherooriginal
        if [ $exito == true ]; then
            resultado="Histórico exportado al directorio ${dir} con el nombre: ${fichero}"
        else
            resultado='Algo salio mal y no se pudo realizar la exportación'
        fi
    fi
}

function UsodeOrdenes(){
    declare -A reg
    count=1
    long=$(wc -l $1 | cut -d' ' -f1)

    while [ $count -le $long ]; do #Introducir o actualizar ordenes
        check=false
        linea=$(awk "NR==$count" $1 | cut -d' ' -f1)

        for registro in "${!reg[@]}"; do #Comprar si la linea actual ya esta en el array !:Clave del registro
            if [[ $registro == $linea ]]; then
                check=true
            fi
        done

        if [ $check == true ]; then #Si la linea existe en el registro sumara uno al valor, sino lo introducira como un nuevo registro
            let reg["${linea}"]="${reg[$linea]}"+1
        else
            let reg["${linea}"]=1
        fi

        let count=${count}+1
    done

    for i in "${!reg[@]}"; do #Imprimir registro de mayor a menor separando valor y clave con ":"
    
        printf '%s:%s\n' "$i" "${reg[$i]}"
    done | sort -t : -k 2nr > ${HOME}/.History/list.temp #Lo guardamos en un archivo temporal para tratarlo despues

    declare -A grupos
    while read line; do #Poner todas las ordenes con el mismo valor en una linea
        orden=$(echo "$line" | cut -d':' -f1)
        numero=$(echo "$line" | cut -d':' -f2)

        if [[ $numero == $old ]]; then #Tratar la orden y su valor y meterla en un array.     
            oldord="$oldord $orden"
            grupos["${numero}"]="$oldord"
        else
            old=${numero}
            oldord=${orden}
            grupos["${numero}"]="$oldord"
        fi
    done < ${HOME}/.History/list.temp

    for i in "${!grupos[@]}"; do #Preparar la impresion por pantalla del uso de las ordenes
        let n=$i
        let count=0
        bar=""

        while [ $count -lt $n ]; #Añadir tantas "|" como veces aparezca la orden
        do
            bar="${bar}|"
            let count=$count+1
        done

        echo "$i ${grupos[$i]}: $bar"
    done | sort -k 1nr

    rm ${HOME}/.History/list.temp
}

#Borrar archivo temporal
#| sort -t : -k 1nr

function DesglosarHistorico() {
    dir=$1
    hist=$2
    orden=$3
    ruta="${HOME}/.History/Histories/${dir}/${hist}"
    cat $ruta | grep "${orden}" > ${HOME}/.History/Temp/desglose.temp
    vacio=false
    contador=$(wc -l ${HOME}/.History/Temp/desglose.temp | cut -d' ' -f1)
    if zenity --text-info \
    --title="Desglose de ${contador} lineas" \
    --filename=${HOME}/.History/Temp/desglose.temp \
    --checkbox="Guardar como historico."
    then
        #Meter logica de guardar el temporal como "date.orden" en el directorio Command
        rutaorigen="${HOME}/.History/Temp/desglose.temp"
        ficherooriginal=`date +%Y_%m_%d`".${orden}"
        fichero=$ficherooriginal
        rutadestino="${HOME}/.History/Histories/Command/${ficherooriginal}"
        if [ -e $rutaorigen ]; then
            GuardarSinRepetir $rutaorigen $rutadestino $ficherooriginal
            if [ $exito == true ]; then
                resultado="Histórico guardado al directorio ${dir} con el nombre: ${fichero}"
                rm $rutaorigen
            else
                resultado='Algo salio mal y no se pudo realizar la exportación'
            fi
        fi  
    else
        resultado="Histórico no guadado"
    fi
}